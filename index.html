<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>刮刮樂進銷存系統</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background: #f8f9fa; padding-bottom: 100px; }
        .table-main { background: white; border: 2px solid #333; }
        .table-main th { background: #eee; text-align: center; border: 1px solid #333; }
        .table-main td { border: 1px solid #333; padding: 5px; }
        .input-cell { width: 100%; border: none; text-align: center; outline: none; }
        .input-cell:focus { background: #fffde7; }
        .total-bar { position: fixed; bottom: 0; width: 100%; background: #333; color: gold; padding: 15px; font-size: 1.5rem; text-align: center; font-weight: bold; }
        .btn-add { margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container-fluid py-3">
    <h3 class="text-center mb-4">刮刮樂結帳表 (進銷存)</h3>
    
    <div class="d-flex justify-content-between">
        <button class="btn btn-dark btn-add" onclick="addNewRow()">＋ 新增刮刮樂品項</button>
        <button class="btn btn-danger btn-add" onclick="submitData()">確認結帳並上傳</button>
    </div>

    <div class="table-responsive">
        <table class="table table-main">
            <thead>
                <tr>
                    <th rowspan="2" style="width: 150px;">刮刮樂品項</th>
                    <th colspan="2">庫存 (本)</th>
                    <th rowspan="2">前日<br>零張</th>
                    <th colspan="2">現量 (今日剩餘)</th>
                    <th rowspan="2">= 售出<br>(張)</th>
                    <th rowspan="2">金額<br>(元)</th>
                    <th rowspan="2">操作</th>
                </tr>
                <tr>
                    <th>前日</th>
                    <th>新進</th>
                    <th>整本</th>
                    <th>零張</th>
                </tr>
            </thead>
            <tbody id="scratchBody">
                </tbody>
        </table>
    </div>
</div>

<div class="total-bar">
    今日刮刮樂總金額：$ <span id="grandTotal">0</span>
</div>

<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header"><h5>新增品項設定</h5></div>
      <div class="modal-body">
        <label>品名</label><input type="text" id="m_name" class="form-control mb-2" placeholder="例如：超級紅包">
        <label>單本張數</label><input type="number" id="m_size" class="form-control mb-2" value="19">
        <label>單價 (元/張)</label><input type="number" id="m_price" class="form-control mb-2" value="2000">
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" onclick="confirmAdd()">確認新增</button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js"></script>
<script>
let items = [];
const addModal = new bootstrap.Modal(document.getElementById('addModal'));

function addNewRow() {
    addModal.show();
}

function confirmAdd() {
    const name = document.getElementById('m_name').value;
    const size = document.getElementById('m_size').value;
    const price = document.getElementById('m_price').value;
    
    if(!name) return alert("請輸入名稱");

    const id = Date.now();
    const html = `
        <tr id="row_${id}" data-size="${size}" data-price="${price}" data-name="${name}">
            <td class="text-center fw-bold">${name}<br><small class="text-muted">${price}元 / ${size}張</small></td>
            <td><input type="number" class="input-cell p_b" value="0" oninput="calc(${id})"></td>
            <td><input type="number" class="input-cell n_b" value="0" oninput="calc(${id})"></td>
            <td><input type="number" class="input-cell p_l" value="0" oninput="calc(${id})"></td>
            <td><input type="number" class="input-cell t_b" value="0" oninput="calc(${id})"></td>
            <td><input type="number" class="input-cell t_l" value="0" oninput="calc(${id})"></td>
            <td id="sold_${id}" class="text-center fw-bold text-primary">0</td>
            <td id="subt_${id}" class="text-center fw-bold text-danger">0</td>
            <td><button class="btn btn-sm btn-outline-secondary" onclick="document.getElementById('row_${id}').remove(); calcAll();">刪除</button></td>
        </tr>
    `;
    document.getElementById('scratchBody').insertAdjacentHTML('beforeend', html);
    addModal.hide();
}

function calc(id) {
    const row = document.getElementById(`row_${id}`);
    const size = Number(row.dataset.size);
    const price = Number(row.dataset.price);
    
    const pB = Number(row.querySelector('.p_b').value) || 0;
    const nB = Number(row.querySelector('.n_b').value) || 0;
    const pL = Number(row.querySelector('.p_l').value) || 0;
    const tB = Number(row.querySelector('.t_b').value) || 0;
    const tL = Number(row.querySelector('.t_l').value) || 0;
    
    // 公式: (前日本 + 新進本 - 今日剩餘本) * 單本張數 + (前日零張 - 今日零張)
    const soldCount = ((pB + nB - tB) * size) + (pL - tL);
    const soldMoney = soldCount * price;
    
    document.getElementById(`sold_${id}`).innerText = soldCount;
    document.getElementById(`subt_${id}`).innerText = soldMoney.toLocaleString();
    
    calcAll();
}

function calcAll() {
    let total = 0;
    document.querySelectorAll('[id^="subt_"]').forEach(el => {
        total += Number(el.innerText.replace(/,/g, ''));
    });
    document.getElementById('grandTotal').innerText = total.toLocaleString();
}

async function submitData() {
    const SCRIPT_URL = "您的AppsScript部署網址";
    const total = document.getElementById('grandTotal').innerText;
    
    let details = "";
    document.querySelectorAll('#scratchBody tr').forEach(tr => {
        const name = tr.dataset.name;
        const sold = tr.querySelector('[id^="sold_"]').innerText;
        const money = tr.querySelector('[id^="subt_"]').innerText;
        details += `${name}: 售出${sold}張, 金額${money}元 | `;
    });

    if(!confirm(`總計 $${total}，確定上傳？`)) return;

    try {
        await fetch(SCRIPT_URL, {
            method: 'POST',
            body: JSON.stringify({ totalSales: total, details: details })
        });
        alert("上傳成功！");
    } catch(e) { alert("上傳失敗"); }
}
</script>
</body>
</html>

