<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°å½©é‹å½©æ——è‰¦çµå¸³ç³»çµ±</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root { --primary: #d00000; --secondary: #3d5a80; }
        body { background: #f4f7f6; font-family: sans-serif; padding-bottom: 100px; }
        .login-overlay { position: fixed; inset: 0; background: #fff; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .card { border: none; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-bottom: 1.5rem; }
        .card-header { background: #fff; font-weight: bold; border-bottom: 2px solid var(--primary); color: var(--primary); }
        .real-time-bar { position: fixed; bottom: 0; width: 100%; background: #222; color: #fff; padding: 15px 0; z-index: 1000; }
        .val-box { font-size: 1.2rem; font-weight: bold; }
        .diff-plus { color: #00ff00; } .diff-minus { color: #ff4d4d; }
    </style>
</head>
<body>

<div id="loginPage" class="login-overlay">
    <div class="text-center">
        <h4>è«‹è¼¸å…¥åº—è™Ÿå¯†ç¢¼</h4>
        <input type="password" id="passInput" class="form-control mb-3 text-center" placeholder="****">
        <button onclick="checkLogin()" class="btn btn-primary w-100">ç™»å…¥ç³»çµ±</button>
    </div>
</div>

<div class="container py-4">
    <h2 class="text-center mb-4">ğŸª æ¯æ—¥çµå¸³å ±è¡¨</h2>
    
    <form id="payForm">
        <div class="card">
            <div class="card-header">åŸºæœ¬è³‡è¨Š</div>
            <div class="card-body row g-3">
                <div class="col-6"><label>æ—¥æœŸ</label><input type="date" name="date" class="form-control" id="today"></div>
                <div class="col-6"><label>ç­åˆ¥</label>
                    <select name="shift" class="form-select"><option>æ—©ç­</option><option>æ™šç­</option><option>å…¨æ—¥</option></select>
                </div>
                <div class="col-12"><label>çµå¸³äººå“¡</label><input type="text" name="staff" class="form-control" required></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">å°å½©é›»è…¦å‹ (Lotto)</div>
            <div class="card-body row g-2">
                <div class="col-6"><label>éŠ·å”®</label><input type="number" name="lottoSales" class="form-control calc" value="0"></div>
                <div class="col-6"><label>ä½œå»¢</label><input type="number" name="lottoVoid" class="form-control calc" value="0"></div>
                <div class="col-6"><label>åº—å…§å…Œç</label><input type="number" name="lottoPayoutIn" class="form-control calc" value="0"></div>
                <div class="col-6"><label>è·¨åº—å…Œç</label><input type="number" name="lottoPayoutOut" class="form-control calc" value="0"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">åˆ®åˆ®æ¨‚ (Scratch)</div>
            <div class="card-body">
                <label class="text-muted mb-2">æœ¬æ¬¡æ‹†å°é¢é¡ç¸½è¨ˆ (æˆæœ¬)</label>
                <input type="number" name="scratchLoad" class="form-control mb-3" placeholder="è«‹è¼¸å…¥æœ¬æ¬¡æ‹†å°ç¸½é¢é¡" value="0">
                <hr>
                <p class="small text-secondary">éŠ·å”®æ¸…é» (å¼µæ•¸)</p>
                <div class="row g-2">
                    <div class="col-4">2000å…ƒ<input type="number" data-p="2000" class="form-control s-calc" value="0"></div>
                    <div class="col-4">1000å…ƒ<input type="number" data-p="1000" class="form-control s-calc" value="0"></div>
                    <div class="col-4">500å…ƒ<input type="number" data-p="500" class="form-control s-calc" value="0"></div>
                    <div class="col-4">300å…ƒ<input type="number" data-p="300" class="form-control s-calc" value="0"></div>
                    <div class="col-4">200å…ƒ<input type="number" data-p="200" class="form-control s-calc" value="0"></div>
                    <div class="col-4">100å…ƒ<input type="number" data-p="100" class="form-control s-calc" value="0"></div>
                </div>
                <div class="row g-2 mt-3">
                    <div class="col-6"><label>éŠ·å”®ç¸½è¨ˆ</label><input type="number" name="scratchSales" id="scTotal" class="form-control bg-light" readonly></div>
                    <div class="col-6"><label>ç¾å ´å…Œç</label><input type="number" name="scratchPayout" class="form-control calc" value="0"></div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">é‹å‹•å½©åˆ¸ (Sport)</div>
            <div class="card-body row g-2">
                <div class="col-4"><label>éŠ·å”®</label><input type="number" name="sportSales" class="form-control calc" value="0"></div>
                <div class="col-4"><label>ä½œå»¢</label><input type="number" name="sportVoid" class="form-control calc" value="0"></div>
                <div class="col-4"><label>å…Œç</label><input type="number" name="sportPayout" class="form-control calc" value="0"></div>
                <div class="col-6"><label>æœƒå“¡å„²å€¼</label><input type="number" name="memberIn" class="form-control calc" value="0"></div>
                <div class="col-6"><label>æœƒå“¡å‡ºé‡‘</label><input type="number" name="memberOut" class="form-control calc" value="0"></div>
                <div class="col-12"><label>è™›æ“¬æ¥­ç¸¾</label><input type="number" name="sportVirtual" class="form-control" value="0"></div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">é»éˆ”èˆ‡æ”¯å‡º</div>
            <div class="card-body">
                <div class="row g-2 mb-3">
                    <div class="col-4">1000x<input type="number" data-c="1000" class="form-control c-calc" value="0"></div>
                    <div class="col-4">500x<input type="number" data-c="500" class="form-control c-calc" value="0"></div>
                    <div class="col-4">100x<input type="number" data-c="100" class="form-control c-calc" value="0"></div>
                    <div class="col-4">50x<input type="number" data-c="50" class="form-control c-calc" value="0"></div>
                    <div class="col-4">10x<input type="number" data-c="10" class="form-control c-calc" value="0"></div>
                    <div class="col-4">5/1x<input type="number" id="smallC" class="form-control c-calc-m" value="0"></div>
                </div>
                <div class="row g-2">
                    <div class="col-6"><label>æ”¯å‡ºé …ç›®</label><input type="text" name="expNote" class="form-control"></div>
                    <div class="col-6"><label>æ”¯å‡ºé‡‘é¡</label><input type="number" name="expAmount" class="form-control calc" value="0"></div>
                </div>
            </div>
        </div>

        <div class="mb-3"><label>å‚™è¨»</label><textarea name="memo" class="form-control"></textarea></div>

        <button type="button" onclick="sendToSheet()" class="btn btn-danger btn-lg w-100 mb-5">ç¢ºèªä¸Šå‚³å ±è¡¨</button>
    </form>
</div>

<div class="real-time-bar text-center">
    <div class="row mx-0">
        <div class="col-4"><div class="small">æ‡‰æœ‰ç¾é‡‘</div><div id="expV" class="val-box">0</div></div>
        <div class="col-4"><div class="small">å¯¦éš›ç¾é‡‘</div><div id="actV" class="val-box">0</div></div>
        <div class="col-4"><div class="small">å·®é¡</div><div id="diffV" class="val-box">0</div></div>
    </div>
</div>

<script>
const SCRIPT_URL = "æ‚¨çš„æ–°éƒ¨ç½²ç¶²å€"; // ğŸ’¡ è«‹è²¼ä¸Šæ‚¨æœ€æ–°éƒ¨ç½²çš„ç¶²å€

function checkLogin() {
    if(document.getElementById('passInput').value === '8888') { // ğŸ’¡ é è¨­å¯†ç¢¼ 8888
        document.getElementById('loginPage').style.display = 'none';
    } else { alert('å¯†ç¢¼éŒ¯èª¤'); }
}

document.getElementById('today').valueAsDate = new Date();

// å¯¦æ™‚è¨ˆç®—
document.querySelectorAll('input').forEach(input => {
    input.addEventListener('input', () => {
        // 1. åˆ®åˆ®æ¨‚ç¸½éŠ·
        let scT = 0;
        document.querySelectorAll('.s-calc').forEach(i => scT += (i.value*i.dataset.p));
        document.getElementById('scTotal').value = scT;

        // 2. æ‡‰æœ‰ç¾é‡‘ = (å°å½©éŠ·-ä½œ-å…Œ) + (åˆ®éŠ·-å…Œ) + (é‹éŠ·-ä½œ-å…Œ) + (å„²å€¼-å‡ºé‡‘) - é›œæ”¯
        const get = (n) => Number(document.querySelector(`[name="${n}"]`).value) || 0;
        const lotto = get('lottoSales') - get('lottoVoid') - get('lottoPayoutIn') - get('lottoPayoutOut');
        const scratch = scT - get('scratchPayout');
        const sport = get('sportSales') - get('sportVoid') - get('sportPayout');
        const member = get('memberIn') - get('memberOut');
        const expected = lotto + scratch + sport + member - get('expAmount');

        // 3. å¯¦éš›ç¾é‡‘
        let actual = 0;
        document.querySelectorAll('.c-calc').forEach(i => actual += (i.value*i.dataset.c));
        actual += (Number(document.getElementById('smallC').value) || 0);

        document.getElementById('expV').innerText = expected.toLocaleString();
        document.getElementById('actV').innerText = actual.toLocaleString();
        const diff = actual - expected;
        const dEl = document.getElementById('diffV');
        dEl.innerText = diff.toLocaleString();
        dEl.className = 'val-box ' + (diff >= 0 ? 'diff-plus' : 'diff-minus');
    });
});

async function sendToSheet() {
    const form = document.getElementById('payForm');
    const data = Object.fromEntries(new FormData(form).entries());
    data.expectedCash = document.getElementById('expV').innerText.replace(/,/g,'');
    data.actualCash = document.getElementById('actV').innerText.replace(/,/g,'');
    data.diff = document.getElementById('diffV').innerText.replace(/,/g,'');

    if(!confirm("ç¢ºå®šé€å‡ºçµå¸³å–®ï¼Ÿ")) return;
    
    try {
        await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify(data), mode: 'no-cors' });
        alert("ä¸Šå‚³æˆåŠŸï¼");
        location.reload();
    } catch(e) { alert("éŒ¯èª¤: " + e); }
}
</script>
</body>
</html>

